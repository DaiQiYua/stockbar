# 股票工具栏代码优化计划

## 1. 优化目标
- 移除重复代码，提高代码复用性
- 优化性能，减少不必要的资源消耗
- 重构代码结构，提高代码可读性和可维护性
- 修复配置不一致问题
- 添加适当的注释和文档字符串

## 2. 具体优化项

### 2.1 ui.py 文件优化

#### 2.1.1 移除重复代码
- 删除重复定义的 `calculate_luminance` 函数（第43-57行）
- 删除重复定义的 `get_contrast_color` 函数（第60-69行）
- 删除重复定义的 `update_label_layout` 方法（第848-888行）
- 移除 `create_ui_components` 方法中重复计算的 `self.text_color`（第116行）
- 移除 `show_pankou_info` 方法中重复获取盘口数据的代码（第1038-1040行）

#### 2.1.2 优化性能
- 简化 `bind_mouse_events` 方法，避免不必要的递归绑定
- 优化 `show_pankou_info` 方法，减少窗口创建和销毁的频率
- 改进股票信息更新机制，减少不必要的UI更新

#### 2.1.3 重构代码结构
- 将 `draw_simple_chart` 方法拆分为多个小方法，提高可读性
- 将 `show_pankou_info` 方法拆分为多个小方法，提高可读性
- 提取重复的UI更新逻辑为单独的方法

#### 2.1.4 修复逻辑问题
- 移除 `update_layout` 方法中重复调用的 `update_layout_ratio`（第887行）
- 统一 `info_ratio` 的设置逻辑

### 2.2 config.py 文件优化

#### 2.2.1 修复配置不一致问题
- 在默认配置中添加 `chart_height` 键，或从 `get_appearance_settings` 方法中移除该配置
- 确保所有配置键在默认配置和获取方法中保持一致

### 2.3 其他优化

#### 2.3.1 代码风格优化
- 添加适当的注释和文档字符串
- 统一代码缩进和命名规范
- 移除不必要的空行和注释

#### 2.3.2 性能优化
- 优化股票数据更新线程，减少对UI线程的影响
- 改进分时图绘制逻辑，减少不必要的重绘

## 3. 优化步骤

1. 首先移除明显的重复代码和冗余逻辑
2. 然后优化性能问题，特别是UI相关的性能
3. 接着重构代码结构，提高代码可读性和可维护性
4. 最后修复配置不一致问题和优化代码风格

## 4. 预期效果

- 代码量减少，提高代码复用性
- 性能提升，减少资源消耗
- 代码结构更清晰，易于维护和扩展
- 配置更一致，减少潜在的bug
- 代码可读性提高，便于后续开发

## 5. 风险评估

- 重构可能引入新的bug，需要仔细测试
- 性能优化可能影响功能，需要进行充分的测试
- 配置修改可能影响现有用户的设置，需要考虑向后兼容性

## 6. 测试计划

- 测试所有功能是否正常工作
- 测试性能是否有明显提升
- 测试配置是否正确加载和保存
- 测试不同场景下的稳定性

## 7. 优化优先级

1. 高优先级：移除重复代码和修复明显的bug
2. 中优先级：优化性能和重构代码结构
3. 低优先级：代码风格优化和添加注释